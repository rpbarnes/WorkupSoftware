\documentclass[10pt]{book}
\newif\ifshowall
\showalltrue
%\showallfalse
%\documentclass[twocolumn,nofootinbib]{revtex4}
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{mynotebook}
%\usepackage[english,greek]{babel}
\synctex=1
%DIF PREAMBLE EXTENSION ADDED BY LATEXDIFF
%DIF UNDERLINE PREAMBLE %DIF PREAMBLE
\RequirePackage[normalem]{ulem} %DIF PREAMBLE
\RequirePackage{color}\definecolor{RED}{rgb}{1,0,0}\definecolor{BLUE}{rgb}{0,0,1} %DIF PREAMBLE
%\providecommand{\DIFadd}[1]{\begingroup\protect\color{blue}\uwave{#1}\endgroup} %DIF PREAMBLE
\providecommand{\DIFadd}[1]{#1} %DIF PREAMBLE
%\providecommand{\DIFdel}[1]{\begingroup\protect\color{red}\sout{#1}\endgroup}                      %DIF PREAMBLE
\providecommand{\DIFdel}[1]{#1}                      %DIF PREAMBLE
%DIF SAFE PREAMBLE %DIF PREAMBLE
\providecommand{\DIFaddbegin}{\color{blue}} %DIF PREAMBLE
\providecommand{\DIFaddend}{\color{black}} %DIF PREAMBLE
\providecommand{\DIFdelbegin}{} %DIF PREAMBLE
\providecommand{\DIFdelend}{} %DIF PREAMBLE
%DIF FLOATSAFE PREAMBLE %DIF PREAMBLE
\providecommand{\DIFaddFL}[1]{\DIFadd{#1}} %DIF PREAMBLE
\providecommand{\DIFdelFL}[1]{\DIFdel{#1}} %DIF PREAMBLE
\providecommand{\DIFaddbeginFL}{} %DIF PREAMBLE
\providecommand{\DIFaddendFL}{} %DIF PREAMBLE
\providecommand{\DIFdelbeginFL}{} %DIF PREAMBLE
\providecommand{\DIFdelendFL}{} %DIF PREAMBLE
%DIF END PREAMBLE EXTENSION ADDED BY LATEXDIFF
\usepackage[nolandscape]{mylists}

\author{Ryan Barnes}
\title{ODNP Workup Software}
\date{\today}
\begin{document}
\maketitle
\chapter{Introduction}
This guide outlines, in very rough detail, the how to of operating the ODNP workup software with python. Right now this is fairly unorganized but I would appreciate your help in making this work towards what you need it for. 

\chapter{Installation}
\section{Windows Install}
This details how to install the necessary software on windows. This will also go through how to get the program setup and running.
\subsection{Necessary Packages}
\begin{enumerate}
    \item Download \& install 'python xy' \o[Make sure to do the full install instead of the defaul custom install.]{}
        \begin{enumerate}
            \item Install 'pymongo' do this by typing 'easy_install pymongo' in the commandline. Note that if the command line yells at you that easy_install is not a recognized command you need to edit the path variable to inclue the python directory in the program files x86 directory. Google is yo friend.
        \end{enumerate}
    \item Download \& install 'git'
    \item Ask Ryan to share the 'workupSoftware' repository with you and follow the instructions for how to clone that repository to a directory of your choice.
    \item Install vim74 \o[This is for me (Ryan) for when I go play on your computer. If you install this you get major brownie points :)]{}
    \item Install notepad \o[This is for you and will make your life easier for when you need to edit the programs, which hopefully you wont have to do.]{Or you can just use the native spyder editor which comes with python xy}
    \item Install latex via texlive for windows. Just run the simple install. \o[This takes a long ass time so start this early.]{}
\end{enumerate}
\chapter{Guide to Running the Workup Code}
Put instructions here for running the workup code. Initially go through the answers for the query statements, especially how to enter the dnp and t1 exp numbers. Then go through exceptions and how the user should use the command line to remedy the situation.

\section{Getting Started}
Here go through how to get up and running once everything is installed.

\chapter{Database Information}
I'm using mongodb to database all the worked up data according to a hierarchical scheme. This will allow a user to search the database for entries based on certain parameters. 

\section{Database Key Definitions}
Currently the search headings include:
\begin{enumerate}
    \item \o{operator} - this is the experimenter's name e.g. Ryan Barnes.
    \item \o{date} - this is the date of the experiment
    \item \o{setType} - this is the data set type e.g. (kSigma, T1Series, enhancementSeries, T10)
    \item \o{macroMolecule} - this is the macromolecule in the sample e.g. protein, liposome. \o[If there is no macromolecule this is set to none.]{} 
    \item \o{bindingPartner} - this is the other macromolecule in sample that is not spin labeled. \o[If there is no other macromolecule in the sample this is set to none.]{} 
    \item \o{concentration} - this is the concentration of the \o{macroMolecule}, this assumes the spin label is the same concentration.
    \item \o{temperature(K)} - this is the temperature of the experiment set in Kelvin.
    \item \o{solvent} - this is the solvent for the experiment.
    \item \o{osmolyte} - This might be nice for Jinsuk for now this isn't used.
    \item \o{aggregationAgent} - this is more a place holder for experiments with the tau protein.
\end{enumerate}
\section{Pulling Data from the Database}

Right now this is notes to Ryan. 
I make a first attempt at pulling the ODNP data, specifically $k_{\sigma}$ data from the database in the script \o['returnDatabaseCheY.py']{}.

This code is a mess but does what is necessary to store the $k_{\sigma}$ data value and error in a nddata. Unfortunately the nddata set is not more help in storing the values. Currently I have to make a data matrix and an error matrix as well as dimension count lists and use these dimension count lists to dump the data and error from the database into the data and error matricies. I then take the full matricies and set this as my data for my nddata set. \o[You could fix the nddata so it sets the data and error value for the appropriate indecies given, currently it does not do this and is very frustrating.]{}

Also to note this code is functionally dynamic, so if any of the dimensions grow the code should handle it.

Another note is that the connection does not work from chembiochemGuest for whatever reason, but this brings up the point that you should house the database locally and sync the local database with the one online 

\o[This will silently fail if it over writes a value in a given matrix.]{You should add a check to make sure that a value doesn't already exist in the matrix position.}

I think what I've learned is that it's not nice to drop everything in one matrix because you can't really handle any repeat experiment with any flexibility other than just hardcoding.

What you should do is loop through producing nddata sets given appropriate search parameters. This is the easiest way to do this for now. 

\chapter{Development:}
\section{New Implementations:}
\begin{enumerate}
    \item $\Box$ In database the 'setType' key should define either the experiment or the workup series\ldots Maybe.
    \item $\Box$ You should move all of the data in the database dictionaries to a data subfield in which you hold all relevant data sets. This way you could make the database search and drop something more dynamic and not depend on several if statements.
    \item $\checkmark$ For the repeat database entry key. You should pull the repeats for the count of database items corresponding to the macromolecule, bindingpartner, and spinlabelsite. \o[I've changed the script that pulls the data sets from the database to do this.]{}
    \item $\checkmark$ DATABASE: What you should do is loop through producing nddata sets given appropriate search parameters. This is the easiest way to do this for now. \o[This now works fairly well, I have a function to return a 1D nddata set and this seems to work ok for the moment.]{}
    \item $\Box$ In the future you should play with using mongodb aggregate functions to make querying the database easier.
    \item $\Box$ Sort database dictionary alphabetically before presentation.
    \item $\Box$ Add net magnetization plot to the output pdf! This is a nice check to see that the T1 power series makes sense.
    \item $\Box$ You need a couple of data sets from the emx odnp system to calibrate your code to.
    \item $\checkmark$ You need to list the relevant ODNP parameters in the pdf produced. You should also make it so the $T_1$ value is written below the $T_1$ integral graph.
    \item $\Box$ You should add a check when a user changes key value. This check should run through the existing keys values to make sure that the value has already been entered, if it is a new key value the program should ask if this new key value is correctly entered, the idea is to catch mistakes in spelling. \o[Another way would be to let the user choose from a list of options instead of having to type in the key value.]{Actually I like the idea of a dynamic list for editing a key value instead of the user entering their own key values.}
    \item $\checkmark$ Open a file dialog so the user can pick their experiment directory and the experiment file to work up. \o[This is done in concept, the minimum running example is in 'fileDialog.py'. You just need to implement and wrap into 'returnIntegrals.py']{}
    \item $\Box$ Make it so the notebook shows the operators name, not mine. \o[I don't think this is going to work like it should. Something weird with the latex package calls. Right now it just says Han Lab Notebook.]{}
    \item $\Box$ system calls that handle both windows and mac both in naming the file type and in compiling the pdf.
    \item $\Box$ Make a way to reload the freshly produced pdf. Mac will work with preview (you just need to set to use preview by default). Windows should work with Sumatra pdf --> This seems to work for mac nicely, need to add windows features now.
    \item $\checkmark$ Axis labels in the last plots generated by the code. This is important for kSigma because you want to give the appropriate units!
    \item $\checkmark$ You should make it so that the database dictionary keys are pulled from the live database and fill in the key values from the default file in the directory. Or keep a copy of the directory keys and if the current keys are different than the directory keys just update the directory keys. \o[It looks like you will have to home roll a function to print all keys.]{Keys are now pulled from the live database and the key values are filled in from the operator's last entry.}
    \item $\checkmark$ When entering database values you should list all possible choices for the given key. Use '.distinct('keyValue')'. \o[You should make it so the database values that are returned are operator specific.]{}
    \item $\checkmark$ Add handlers for mistyped answers so program does not crash. Just say do not understand and re loop through the question in a while loop. \o[This still needs done for the error handling functions.]{The error handling function need reworked I think. It was a good try but there is too much static code, it needs to be switched to dynamic type.}
    \item $\checkmark$ Change the experimental parameters queries to dynamic type like the database queries \o[This should be thoroughly debugged, it's not right now which might be a problem.]{This actually seems to work nicely now.}
    \item $\Box$ Newton's method to find starting guess for T1 experiments. For now the t1StartingGuess works 
    \item $\checkmark$ Make a way to force an experiment time for diving up the powers files \o[I pull the experiment time from the Bruker output and set this as the minimum experiment time. If the experiment is successful the workup software should work fine dividing up the powers.]{}
    \item $\checkmark$ You should calculate the experiment time from the Bruker timing function and hand this with an associated arror to the 'returnSplitPowers' function. \o[Right now this pulls the experiment time and uses as a lower bound for the split powers function.]{}
\end{enumerate}
\section{Bugs:}
\begin{enumerate}
    \item $\Box$ Code hard fails when the $T_1$ fit fails. This should at least give a warning, although adding newton's method should alleviate future failures.
    \item $\Box$ I truly do not believe my $T_1$ error estimate from the covariance.
    \item $\Box$ When working up a short experiment such as \o['150211_4OHT_400uM_25pGlyH2O_250K_ODNP']{} I get an error because it under estimates the maximum experiment time. For now it's just hardset to be 20 seconds longer than it should be.
    \item $\Box$ RyanS_2015_1_30_psk1_DNP is a good reason to force experiment time for finding powers.
    \item $\Box$ RyanS_2015_1_30_DOPC_postP188_110uM_tempo_DI_dnp crashes hard because dnpExps aren't set right. 
    \item $\Box$ in \o['150128_CheY_M17C_None_202uM_RT_ODNP_REPEAT']{} the $T_1$ powers function misses the first power. This is strange. For now I've just dropped the $T_1$ value.
    \item $\Box$ The M17C set has a database entry for setType = kSigmaSeries. However there is no data stored in the database dictionary. This should not happen and if continues to will make a mess in the database.
    \item $\Box$ There needs to be a better way to set the repeat counter. It's hard to tell what already exists in the database.
    \item $\Box$ The way you compile the pdf is stupid. You should change this to speed up the code significantly.
    \item $\Box$ You need to remove any instance of the database parameters file.
    \item $\checkmark$ Add a check so that you don't overwrite matrix vales when you pull the values from the database. \o[Well it doesn't silently fail now but it still fails and I'm not sure of a good way to handle it other than writing a new matrix to hold the conflicted values.]{More thinking to come.}
    \item $\checkmark$ For an old database entry the keys and values pulled do not contain any of the new items. This is to be expected but not ok because it does not allow you to enter information according to new keys\ldots How to do this dynamically? \o[The set '141029_CheY_K91C_P2_320uM_RT_ODNP' currently has this error, I haven't fixed it so when you come to this use this set as your dummy set.]{This seems to work ok now. It pulls the most recent dictionary entry and updates the experiment's database dictionary.}
    \item $\Box$ The database parameter checking should make use of the function returnDatabaseDictionary and you should hand it the necessary keys to drop!
    \item $\Box$ You need to add a test operator and make sure the behavior of the code, primarily the database search, is changed appropriately.
    \item $\Box$ When the internet connection does not exist the code hard crashes. Set a runtime warning when asking user if they want to database their information. Also set a soft crash for when code tries to access database without internet connection.
    \item $\Box$ When the t1SeparatePhaseCycle is not set appropriately the code crashes. You should put in place a graceful crash that tells the user to correct t1SeparatePhaseCycle.
    \item $\checkmark$ If the experiment exists, the database parameters file should be pulled from a search given the experiment name and nothing else. Then you should pop the dims that you don't want to see. 
    \item $\checkmark$ The returnIntegrals opens two connections to the database. You should make it so that only one connection is opened, and that the returndatabase parameters accepts a connection instance instead of creates it's own.
    \item $\checkmark$ If you edit the zeroth item in the dynamic options menu, it breaks the loop and goes on for some reason. \o[This happened because you by chance set answer to False by setting it to zero.]{Fixed now. This was also a problem with the experimental dictionary but is now also fixed.} 
    \item $\Box$ Windows!! You need to debug that bitch!! \o[This is almost done, you just need to finish with the last of the sys calls.]{}
    \item $\checkmark$ When the workup experiment crashes the database parameters dictionary is not saved. This is because it's pulling those parameters from the online dictionary and not from the file. \o[You should make it so you hand the returnDatabase function the name of the experiment. If the experiment name exists just hand back that database entry.]{It now is.}
    \item $\Box$ You should add a method to force a time for the power series. You should print the absolute experiment time underneath the curve so the user can select a start guess and a forced time.
    \item $\Box$ 'returnExpTimes' fails in windows when the experiment files aren't set right. You need to make it so it fails in a way that the user can fix it.
    \item $\checkmark$ 131115_tempcont_dnp_9_58GHz_jss gave power series error, it looks like the time steps are really off. \o[This is actually just a broken experiment.]{No need to adjust code to handle this. I did add functionality to the powers dividing function to drop the first number of time values with 'timeDropStart' and I also added a maximum experiment time as 'expTimeMax'. It might be worth adding debugging functionality to plot the time series and also show the time values of the spikes, this way the experimenter can pick out the values nicely.}
    \item $\checkmark$ 140509_200uM_OHT_ODNP gave an error because a glitch occuring early. You should add a way to throw away values that occur before a certain time. \o[This seems to work now.]{}
    \item $\checkmark$ 140728_CheY_CtermP6C_400uM_ODNP_Repeat2 this throws an error because it can't line up the enhancement series and the powers file. \o[This seems to be resolved. I think an earlier fix to the powers picking function fixed this, mainly choosing a minimum experiment time.]{}
    \item $\Box$ When code crashes due to not lining up the powers file with enhancemnet or $T_1$ series. The powers file is not returned in a csv.
    \item $\Box$ You need to add wrong answer handling to the power series exception handlers.
\end{enumerate}
\section{Methods to Implement:}
\begin{enumerate}
    \item $\Box$ Wrap method of saving the nddata sets to mongo database
    \item $\Box$ Method for print statement headers
\end{enumerate}
\section{Users Guide:}
\begin{enumerate}
    \item $\Box$ Windows installation of packages and use.
    \item $\Box$ Max installation of packages and use.
    \item $\Box$ Introduction to the software.
    \item $\Box$ Walk through of using the program.
    \item $\Box$ Common errors, reasons and how to handle them from the command line.
    \item $\Box$ Explination of functions used \o[This is a backend thing and is not necessary for now.]{}
\end{enumerate}
\chapter{EPR Integral Workup}
Is this necessary for the ODNP? It might be nice to do this as standard this way you can tell if the double integrals are the same. \o[This is a future idea.]

\end{document}
